<html>
<head>
	<script src="https://cdn.firebase.com/js/client/1.0.15/firebase.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/1.0.10/hammer.min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://www.firebase.com/css/example.css">

	<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
</head>

<body id="body">
	<div>
		<canvas id="canvas" width="500" height="500"></canvas>
	</div>
	<input type="button" id="restartButton" value="Restart Game" class="hide" />
	<div id="gameInProgress">Game is in progress.  You will automatically join if either player leaves.</div>


<script>
	var username;

	var canvas = $("#canvas").get(0);
	if (!canvas || !canvas.getContext || !canvas.getContext('2d')) {
		alert("You must use a browser that supports HTML5 Canvas to run this demo.");
	}

	var TicTacToe = {};

	TicTacToe.GAME_LOCATION = "https://flickering-fire-9235.firebaseio.com/"
	
	TicTacToe.ROOM_LOCATION = "rooms";
	TicTacToe.USERS_LOCATION = "users";
	TicTacToe.BOARD_LOCATION = "board";


	/*
		ROOT
			- ROOMS
				- ROOMID/NAME
					- PLAYERS (2)
						- PLAYER NAME
					- BOARD
						- DATA
	*/


	TicTacToe.NUMBER_PLAYERS = 2;

	TicTacToe.BOARD_WIDTH = 3; 
	TicTacToe.BOARD_HEIGHT = 3;

	TicTacToe.BLOCK_SIZE_PIXELS = 25;
	TicTacToe.BOARD_HEIGHT_PIXELS = TicTacToe.BOARD_HEIGHT * TicTacToe.BLOCK_SIZE_PIXELS;
	TicTacToe.BOARD_WIDTH_PIXELS = TicTacToe.BOARD_WIDTH * TicTacToe.BLOCK_SIZE_PIXELS;

	TicTacToe.BLOCK_BORDER_COLOR = "#484848";
	TicTacToe.BLOCKS = {'A': 
  						{'symbol': '×', 'colour': 'red'}, 
  					  'B':
  					  	{'symbol': '?', 'colour': 'blue'}
  					 };

	function start() {
		var gameRef = new Firebase(TicTacToe.GAME_LOCATION);
		var controller = new TicTacToe.Controller(gameRef);
		username = prompt("What's your handle?");
	}

	TicTacToe.Board = function (canvas, ref, room) {
		this.context = canvas.getContext('2d');
		this.ref = ref;
		this.snapshot = null;
		this.isMyBoard = false;

		// Listen for changes to our board.
		var self = this;
		ref.on(TicTacToe.ROOMS + '/' + room + '/' + 'data', function(snapshot) {
			self.snapshot = snapshot;
			self.draw();
		});
	};

	TicTacToe.Board.prototype.draw = function() {
		this.context.clearRect(0, 0, TicTacToe.BOARD_WIDTH_PIXELS, TicTacToe.BOARD_HEIGHT_PIXELS);
		this.context.fillRect(50, 50, 50, 50);
	};

	TicTacToe.Board.prototype.clear = function() {

	};

	/**
	* Manages joining the game, responding to keypresses, making the piece drop, etc.
	*/
	TicTacToe.PlayingState = { Watching: 0, Joining: 1, Playing: 2 };

	TicTacToe.Controller = function (ref) {
		this.ref = ref;
		//this.createBoard();

		this.playingState = TicTacToe.PlayingState.Watching;
		this.waitToJoin();
	};


	TicTacToe.Controller.prototype.waitToJoin = function() {
		var self = this;

		// Listen to 'online' location for player0 and player1.
		this.ref.child('player0/online').on('value', function(onlineSnap) {
			if (onlineSnap.val() === null && self.PlayingState === TicTacToe.PlayingState.Watching) {
				self.tryToJoin(username);
			}
		});

		this.ref.child('player1/online').on('value', function(onlineSnap) {
			if (onlineSnap.val() === null && self.PlayingState === TicTacToe.PlayingState.Watching) {
				self.tryToJoin(username);
			}
		});

	};

	TicTacToe.Controller.prototype.tryToJoin = function(player) {
		this.playingState = TicTacToe.playingState.Joining;

		var self = this;
		this.ref.child(TicTacToe.ROOM_LOCATION + '/')

	};

	TicTacToe.Controller.prototype.startPlaying = function(player) {
		this.ref = username;
		//this.opponentRef = 
		this.ref.child('online').onDisconnect().remove();
		$('#gameInProgress').hide();
	};

	start();

	Hammer(document.getElementById('canvas')).on('tap', function(event) {
		var context = canvas.getContext('2d');
		var center = event.gesture.center;
		var offset = $('#canvas').offset();
		context.fillRect(center.pageX - offset.left, center.pageY - offset.top, 50, 50);
	});

</script>
</body>
</html>